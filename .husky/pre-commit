#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ðŸ” Running pre-commit checks..."

# Function to ensure JWT layer dependencies are installed
ensure_jwt_dependencies() {
    echo "ðŸ“¦ Checking JWT layer dependencies..."
    
    JWT_DIR="lambda-layers/jwt/nodejs"
    
    # Create JWT layer structure if it doesn't exist
    if [ ! -d "$JWT_DIR" ]; then
        echo "ðŸ—ï¸ Creating JWT layer structure..."
        mkdir -p "$JWT_DIR"
        cat > "$JWT_DIR/package.json" << 'EOF'
{
  "name": "jwt-layer",
  "version": "1.0.0",
  "description": "JWT verification layer for Lambda functions",
  "dependencies": {
    "aws-jwt-verify": "^4.0.1"
  }
}
EOF
    fi
    
    # Check if node_modules exists and has aws-jwt-verify
    if [ ! -d "$JWT_DIR/node_modules" ] || [ ! -d "$JWT_DIR/node_modules/aws-jwt-verify" ]; then
        echo "ðŸ”§ Installing JWT layer dependencies..."
        (cd "$JWT_DIR" && npm install)
        echo "âœ… JWT layer dependencies installed"
    else
        echo "âœ… JWT layer dependencies already present"
    fi
}

# Function to run CORS validation
run_cors_validation() {
    echo "ðŸŒ Running CORS validation..."
    if timeout 30s node scripts/validate-cors.js; then
        echo "âœ… CORS validation passed"
        return 0
    else
        echo "âŒ CORS validation failed"
        return 1
    fi
}

# Function to run basic linting
run_lint_check() {
    echo "ðŸ” Running ESLint..."
    if npm run lint; then
        echo "âœ… Linting passed"
        return 0
    else
        echo "âš ï¸ Linting issues found (not blocking commit)"
        return 0  # Don't block commit for linting
    fi
}

# Main execution
echo "Starting pre-commit validation..."

# Ensure JWT dependencies are installed
ensure_jwt_dependencies

# Run CORS validation
if ! run_cors_validation; then
    echo "ðŸš¨ Pre-commit failed: CORS validation errors"
    echo "ðŸ’¡ Try running: node scripts/validate-cors.js"
    exit 1
fi

# Run linting (non-blocking)
run_lint_check

# Run tests (optional, can be commented out if too slow)
echo "ðŸ§ª Running quick tests..."
timeout 60s npm run test || echo "âš ï¸ Tests failed or timed out (not blocking commit)"

echo "ðŸŽ‰ Pre-commit checks completed!"